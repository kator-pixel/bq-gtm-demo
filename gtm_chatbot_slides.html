<script>
    (function () {
        // Prevent duplicate injection
        if (document.getElementById('gtm-chatbot-container')) return;

        // --- Configuration ---
        var CONFIG = {
            botName: 'Slide Controller AI',
            primaryColor: '#2563eb',
            secondaryColor: '#eff6ff',
            textColor: '#1f2937'
        };

        // --- CSS Injection ---
        var style = document.createElement('style');
        style.textContent =
            '#gtm-chatbot-container {' +
            '  font-family: "Noto Sans JP", sans-serif;' +
            '  position: fixed;' +
            '  bottom: 24px;' +
            '  right: 24px;' +
            '  z-index: 9999;' +
            '  display: flex;' +
            '  flex-direction: column;' +
            '  align-items: flex-end;' +
            '}' +
            '#gtm-chat-window {' +
            '  width: 320px;' +
            '  height: 450px;' +
            '  background: white;' +
            '  border-radius: 16px;' +
            '  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);' +
            '  display: flex;' +
            '  flex-direction: column;' +
            '  border: 1px solid #e5e7eb;' +
            '  margin-bottom: 16px;' +
            '  overflow: hidden;' +
            '  transition: all 0.3s ease-in-out;' +
            '  transform: translateY(120%);' +
            '  opacity: 0;' +
            '  pointer-events: none;' +
            '}' +
            '#gtm-chat-window.open {' +
            '  transform: translateY(0);' +
            '  opacity: 1;' +
            '  pointer-events: auto;' +
            '}' +
            '.gtm-chat-header {' +
            '  background-color: ' + CONFIG.primaryColor + ';' +
            '  color: white;' +
            '  padding: 16px;' +
            '  display: flex;' +
            '  justify-content: space-between;' +
            '  align-items: center;' +
            '}' +
            '.gtm-chat-header-title {' +
            '  font-weight: bold;' +
            '  font-size: 0.875rem;' +
            '  display: flex;' +
            '  align-items: center;' +
            '  gap: 8px;' +
            '}' +
            '.gtm-close-btn {' +
            '  background: none;' +
            '  border: none;' +
            '  color: #dbeafe;' +
            '  cursor: pointer;' +
            '  font-size: 1.25rem;' +
            '}' +
            '.gtm-close-btn:hover { color: white; }' +
            '#gtm-chat-messages {' +
            '  flex: 1;' +
            '  padding: 16px;' +
            '  overflow-y: auto;' +
            '  font-size: 0.875rem;' +
            '  background-color: #f9fafb;' +
            '  display: flex;' +
            '  flex-direction: column;' +
            '  gap: 12px;' +
            '}' +
            '.gtm-message-row {' +
            '  display: flex;' +
            '  gap: 8px;' +
            '  align-items: flex-start;' +
            '}' +
            '.gtm-message-row.user { flex-direction: row-reverse; }' +
            '.gtm-message-bubble {' +
            '  padding: 12px;' +
            '  border-radius: 8px;' +
            '  max-width: 90%;' +
            '  line-height: 1.5;' +
            '  word-wrap: break-word;' +
            '}' +
            '.gtm-message-bubble.bot {' +
            '  background-color: white;' +
            '  border: 1px solid #e5e7eb;' +
            '  color: ' + CONFIG.textColor + ';' +
            '  border-top-left-radius: 0;' +
            '}' +
            '.gtm-message-bubble.user {' +
            '  background-color: ' + CONFIG.primaryColor + ';' +
            '  color: white;' +
            '  border-top-right-radius: 0;' +
            '}' +
            '.gtm-chat-input-area {' +
            '  padding: 12px;' +
            '  background: white;' +
            '  border-top: 1px solid #e5e7eb;' +
            '  display: flex;' +
            '  gap: 8px;' +
            '}' +
            '#gtm-user-input {' +
            '  flex: 1;' +
            '  border: 1px solid #d1d5db;' +
            '  border-radius: 8px;' +
            '  padding: 8px 12px;' +
            '  font-size: 0.875rem;' +
            '  outline: none;' +
            '}' +
            '#gtm-user-input:focus { border-color: ' + CONFIG.primaryColor + '; }' +
            '#gtm-send-btn {' +
            '  background-color: ' + CONFIG.primaryColor + ';' +
            '  color: white;' +
            '  border: none;' +
            '  border-radius: 8px;' +
            '  padding: 8px 12px;' +
            '  cursor: pointer;' +
            '  transition: background-color 0.2s;' +
            '}' +
            '#gtm-send-btn:hover { background-color: #1d4ed8; }' +
            '#gtm-toggle-btn {' +
            '  background-color: ' + CONFIG.primaryColor + ';' +
            '  color: white;' +
            '  width: 56px;' +
            '  height: 56px;' +
            '  border-radius: 50%;' +
            '  border: none;' +
            '  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);' +
            '  cursor: pointer;' +
            '  display: flex;' +
            '  align-items: center;' +
            '  justify-content: center;' +
            '  font-size: 1.5rem;' +
            '  transition: transform 0.2s;' +
            '}' +
            '#gtm-toggle-btn:hover {' +
            '  transform: scale(1.1);' +
            '  background-color: #1d4ed8;' +
            '}' +
            '.gtm-options-container {' +
            '  display: flex;' +
            '  flex-direction: column;' +
            '  gap: 8px;' +
            '  margin-top: 8px;' +
            '}' +
            '.gtm-option-btn {' +
            '  background-color: ' + CONFIG.secondaryColor + ';' +
            '  border: 1px solid #bfdbfe;' +
            '  color: #1d4ed8;' +
            '  padding: 8px 12px;' +
            '  border-radius: 20px;' +
            '  text-align: left;' +
            '  font-size: 0.875rem;' +
            '  cursor: pointer;' +
            '  transition: all 0.2s;' +
            '}' +
            '.gtm-option-btn:hover { background-color: #dbeafe; }' +
            '.gtm-icon {' +
            '  width: 1em;' +
            '  height: 1em;' +
            '  fill: currentColor;' +
            '}' +
            // --- Modal CSS ---
            '#gtm-slide-modal {' +
            '  position: fixed;' +
            '  top: 0;' +
            '  left: 0;' +
            '  width: 100%;' +
            '  height: 100%;' +
            '  background-color: rgba(0, 0, 0, 0.8);' +
            '  z-index: 10000;' +
            '  display: flex;' +
            '  justify-content: center;' +
            '  align-items: center;' +
            '  opacity: 0;' +
            '  pointer-events: none;' +
            '  transition: opacity 0.3s ease;' +
            '}' +
            '#gtm-slide-modal.open {' +
            '  opacity: 1;' +
            '  pointer-events: auto;' +
            '}' +
            '.gtm-modal-content {' +
            '  position: relative;' +
            '  max-width: 90%;' +
            '  max-height: 90%;' +
            '  display: flex;' +
            '  align-items: center;' +
            '  justify-content: center;' +
            '}' +
            '.gtm-modal-close {' +
            '  position: absolute;' +
            '  top: -40px;' +
            '  right: 0;' +
            '  color: white;' +
            '  font-size: 2rem;' +
            '  cursor: pointer;' +
            '  background: none;' +
            '  border: none;' +
            '  z-index: 10002;' +
            '}' +
            '.gtm-slide-img {' +
            '  max-width: 100%;' +
            '  max-height: 80vh;' +
            '  border-radius: 8px;' +
            '  display: block;' +
            '  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);' +
            '}' +
            '.gtm-slide-nav {' +
            '  position: absolute;' +
            '  top: 50%;' +
            '  transform: translateY(-50%);' +
            '  background: rgba(255, 255, 255, 0.2);' +
            '  color: white;' +
            '  border: none;' +
            '  width: 48px;' +
            '  height: 48px;' +
            '  border-radius: 50%;' +
            '  cursor: pointer;' +
            '  display: flex;' +
            '  align-items: center;' +
            '  justify-content: center;' +
            '  font-size: 1.5rem;' +
            '  transition: background 0.2s;' +
            '  z-index: 10001;' +
            '}' +
            '.gtm-slide-nav:hover { background: rgba(255, 255, 255, 0.4); }' +
            '.gtm-slide-prev { left: -60px; }' +
            '.gtm-slide-next { right: -60px; }' +
            '.gtm-slide-counter {' +
            '  position: absolute;' +
            '  bottom: -30px;' +
            '  left: 50%;' +
            '  transform: translateX(-50%);' +
            '  color: white;' +
            '  font-size: 0.875rem;' +
            '}' +
            '@media (max-width: 768px) {' +
            '  .gtm-slide-nav { width: 36px; height: 36px; font-size: 1rem; background: rgba(0,0,0,0.5); }' +
            '  .gtm-slide-prev { left: 10px; }' +
            '  .gtm-slide-next { right: 10px; }' +
            '}';
        document.head.appendChild(style);

        // --- HTML Injection ---
        var container = document.createElement('div');
        container.id = 'gtm-chatbot-container';
        container.innerHTML =
            '<div id="gtm-chat-window">' +
            '  <div class="gtm-chat-header">' +
            '    <div class="gtm-chat-header-title">' +
            '      <svg class="gtm-icon" viewBox="0 0 512 512"><path d="M32 224H16c-8.84 0-16 7.16-16 16v192c0 8.84 7.16 16 16 16h16c8.84 0 16-7.16 16-16V240c0-8.84-7.16-16-16-16zm480 0h-16c-8.84 0-16 7.16-16 16v192c0 8.84 7.16 16 16 16h16c8.84 0 16-7.16 16-16V240c0-8.84-7.16-16-16-16zM256 0C114.62 0 0 114.62 0 256s114.62 256 256 256 256-114.62 256-256S397.38 0 256 0zm0 464c-114.69 0-208-93.31-208-208S141.31 48 256 48s208 93.31 208 208-93.31 208-208 208zm-64-288c0 17.67-14.33 32-32 32s-32-14.33-32-32 14.33-32 32-32 32 14.33 32 32zm192 0c0 17.67-14.33 32-32 32s-32-14.33-32-32 14.33-32 32-32 32 14.33 32 32z"/></svg>' +
            '      <span>' + CONFIG.botName + '</span>' +
            '    </div>' +
            '    <button class="gtm-close-btn" id="gtm-close-btn">×</button>' +
            '  </div>' +
            '  <div id="gtm-chat-messages">' +
            '    <div class="gtm-message-row">' +
            '      <div class="gtm-message-bubble bot">' +
            '        こんにちは！気になるトピックを選んでください。<br>' +
            '        関連するスライド資料を表示します。' +
            '      </div>' +
            '    </div>' +
            '  </div>' +
            '  <div class="gtm-chat-input-area">' +
            '    <input type="text" id="gtm-user-input" placeholder="質問を入力...">' +
            '    <button id="gtm-send-btn">' +
            '      <svg class="gtm-icon" viewBox="0 0 512 512"><path d="M476 3.2L12.5 270.6c-18.1 10.4-15.8 35.6 2.2 43.2L121 358.4l287.3-253.2c5.5-4.9 13.3 2.6 8.6 8.3L176 407v80.5c0 23.6 28.5 32.9 42.5 15.8L282 426l124.6 52.2c14.2 6 30.4-2.9 33-18.2l72-432C515 7.8 493.3-6.8 476 3.2z"/></svg>' +
            '    </button>' +
            '  </div>' +
            '</div>' +
            '<button id="gtm-toggle-btn">' +
            '  <svg class="gtm-icon" viewBox="0 0 512 512"><path d="M256 32C114.6 32 0 125.1 0 240c0 49.6 21.4 95 57 130.7C44.5 421.1 2.7 466 2.2 466.5c-2.2 2.3-2.8 5.7-1.5 8.7S4.8 480 8 480c66.3 0 116-31.8 140.6-51.4 32.7 12.3 69 19.4 107.4 19.4 141.4 0 256-93.1 256-208S397.4 32 256 32z"/></svg>' +
            '</button>' +
            // --- Modal HTML ---
            '<div id="gtm-slide-modal">' +
            '  <div class="gtm-modal-content">' +
            '    <button class="gtm-modal-close" id="gtm-modal-close">×</button>' +
            '    <button class="gtm-slide-nav gtm-slide-prev" id="gtm-slide-prev">❮</button>' +
            '    <img id="gtm-slide-image" class="gtm-slide-img" src="" alt="Slide">' +
            '    <button class="gtm-slide-nav gtm-slide-next" id="gtm-slide-next">❯</button>' +
            '    <div class="gtm-slide-counter" id="gtm-slide-counter">1 / 3</div>' +
            '  </div>' +
            '</div>';
        document.body.appendChild(container);

        // --- Logic ---
        var chatWindow = document.getElementById('gtm-chat-window');
        var toggleBtn = document.getElementById('gtm-toggle-btn');
        var closeBtn = document.getElementById('gtm-close-btn');
        var sendBtn = document.getElementById('gtm-send-btn');
        var userInput = document.getElementById('gtm-user-input');
        var messagesContainer = document.getElementById('gtm-chat-messages');

        // Modal Elements
        var modal = document.getElementById('gtm-slide-modal');
        var modalClose = document.getElementById('gtm-modal-close');
        var slideImage = document.getElementById('gtm-slide-image');
        var prevBtn = document.getElementById('gtm-slide-prev');
        var nextBtn = document.getElementById('gtm-slide-next');
        var slideCounter = document.getElementById('gtm-slide-counter');

        // Slide Decks Configuration
        var slideDecks = {
            'overview': [
                'images/slide1.png',
                'images/slide_overview_2.png',
                'images/slide3.png' // Reusing contact as last slide
            ],
            'merits': [
                'images/slide2.png',
                'images/slide_merits_2.png',
                'images/slide_merits_3.png'
            ],
            'contact': [
                'images/slide3.png'
            ]
        };

        var currentDeck = [];
        var currentSlideIndex = 0;

        // 1. Toggle Chat
        function toggleChat() {
            chatWindow.classList.toggle('open');

            // Track Toggle
            if (chatWindow.classList.contains('open')) {
                window.dataLayer = window.dataLayer || [];
                window.dataLayer.push({
                    'event': 'chatbot_toggle',
                    'state': 'open'
                });
            } else {
                window.dataLayer = window.dataLayer || [];
                window.dataLayer.push({
                    'event': 'chatbot_toggle',
                    'state': 'close'
                });
            }
        }
        toggleBtn.addEventListener('click', toggleChat);
        closeBtn.addEventListener('click', toggleChat);

        // 2. Modal Logic
        function updateSlide() {
            if (currentDeck.length === 0) return;
            slideImage.src = currentDeck[currentSlideIndex];
            slideCounter.innerText = (currentSlideIndex + 1) + ' / ' + currentDeck.length;

            // Hide nav buttons if only 1 slide
            if (currentDeck.length <= 1) {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
            } else {
                prevBtn.style.display = 'flex';
                nextBtn.style.display = 'flex';
            }
        }

        function openDeck(deckKey) {
            currentDeck = slideDecks[deckKey] || [];
            if (currentDeck.length === 0) return;

            currentSlideIndex = 0;
            updateSlide();
            modal.classList.add('open');
        }

        function closeModal() {
            if (modal.classList.contains('open')) {
                window.dataLayer = window.dataLayer || [];
                window.dataLayer.push({
                    'event': 'chatbot_modal_close',
                    'last_slide': slideImage.src
                });
            }
            modal.classList.remove('open');
            slideImage.src = '';
        }

        function pushNavEvent(direction) {
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
                'event': 'chatbot_slide_nav',
                'slide_direction': direction,
                'slide_image': currentDeck[currentSlideIndex]
            });
        }

        function nextSlide(e) {
            e.stopPropagation();
            if (currentDeck.length <= 1) return;
            currentSlideIndex = (currentSlideIndex + 1) % currentDeck.length;
            updateSlide();
            pushNavEvent('next');
        }

        function prevSlide(e) {
            e.stopPropagation();
            if (currentDeck.length <= 1) return;
            currentSlideIndex = (currentSlideIndex - 1 + currentDeck.length) % currentDeck.length;
            updateSlide();
            pushNavEvent('prev');
        }

        modalClose.addEventListener('click', closeModal);
        modal.addEventListener('click', function (e) {
            if (e.target === modal) closeModal();
        });
        nextBtn.addEventListener('click', nextSlide);
        prevBtn.addEventListener('click', prevSlide);

        // Keyboard navigation
        document.addEventListener('keydown', function (e) {
            if (!modal.classList.contains('open')) return;
            if (e.key === 'ArrowRight') nextSlide(e);
            if (e.key === 'ArrowLeft') prevSlide(e);
            if (e.key === 'Escape') closeModal();
        });

        // 3. Messaging Logic
        function addMessage(text, sender) {
            var row = document.createElement('div');
            row.className = 'gtm-message-row ' + sender;
            var bubble = document.createElement('div');
            bubble.className = 'gtm-message-bubble ' + sender;
            bubble.innerText = text;
            row.appendChild(bubble);
            messagesContainer.appendChild(row);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function handleSend() {
            var text = userInput.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            userInput.value = '';

            setTimeout(function () {
                addMessage("スライド操作ボタンをご利用ください。", 'bot');
                showOptions();
            }, 500);
        }

        sendBtn.addEventListener('click', handleSend);
        userInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') handleSend();
        });

        // 4. Show Slide Options
        function showOptions() {
            var existing = messagesContainer.querySelectorAll('.gtm-options-container');
            for (var i = 0; i < existing.length; i++) {
                existing[i].remove();
            }

            var optionsContainer = document.createElement('div');
            optionsContainer.className = 'gtm-options-container';

            var buttons = [
                { key: 'overview', label: 'GTMとBigQueryの連携概要' },
                { key: 'merits', label: '具体的なメリットと機能' },
                { key: 'contact', label: '導入相談・お問い合わせ' }
            ];

            for (var i = 0; i < buttons.length; i++) {
                var btnData = buttons[i];
                var btn = document.createElement('button');
                btn.className = 'gtm-option-btn';
                btn.innerText = btnData.label;

                btn.onclick = (function (key, label) {
                    return function () {
                        // Track Category Selection
                        window.dataLayer = window.dataLayer || [];
                        window.dataLayer.push({
                            'event': 'chatbot_select_category',
                            'category_label': label
                        });

                        addMessage(label + 'を表示します', 'user');
                        openDeck(key);
                        setTimeout(function () {
                            addMessage(label + 'のスライドを表示しました。', 'bot');
                        }, 500);
                    };
                })(btnData.key, btnData.label);

                optionsContainer.appendChild(btn);
            }

            var row = document.createElement('div');
            row.className = 'gtm-message-row bot';
            var bubble = document.createElement('div');
            bubble.className = 'gtm-message-bubble bot';
            bubble.innerHTML = '<p style="margin-bottom:8px">興味のある内容を選択してください:</p>';
            bubble.appendChild(optionsContainer);
            row.appendChild(bubble);
            messagesContainer.appendChild(row);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Initialize
        setTimeout(showOptions, 1000);

    })();
</script>